name: Run govulncheck

# triggers: manual and daily
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  govulncheck:
    runs-on: ubuntu-latest
    outputs:
      git_diff_patch: ${{ steps.dump-changes.outputs.git_diff_patch }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Restore stage caches
        id: stage-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            stage/
          key: ${{ runner.os }}-stage

      - name: Prepare Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run scan.sh
        run: ./scan.sh targets.yaml

      - name: Generate report
        run: ./report.sh

      - name: Dump changes to GITHUB_OUTPUT
        run: |
          git add results/
          git add report.md/
          git diff --cached > git-diff.patch
          echo "git_diff_patch=$(cat git-diff.patch)" >> $GITHUB_OUTPUT

      - name: Save stage caches
        id: stage-cache-save
        uses: actions/cache/save@v4
        with:
          path: |
            stage/
          key: ${{ steps.stage-cache-restore.outputs.cache-primary-key }}

  commit:
    runs-on: ubuntu-latest

    needs: govulncheck

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Apply changes
        run: |
          echo ${{ needs.govulncheck.outputs.git_diff_patch }} > git-diff.patch
          git apply git-diff.patch

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: "report.md results/*"
